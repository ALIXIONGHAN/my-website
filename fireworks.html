<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ç’€ç’¨å¤œç©º â€” åœ¨çº¿çƒŸèŠ±ç§€</title>
  <meta name="description" content="æ²‰æµ¸å¼ã€äº’åŠ¨æ€§å¼ºã€è§†è§‰éœ‡æ’¼çš„åœ¨çº¿çƒŸèŠ±ä½“éªŒã€‚æ”¯æŒè‡ªåŠ¨è¡¨æ¼”ä¸æ‰‹åŠ¨ç‡ƒæ”¾ï¼Œå¤šç§çƒŸèŠ±æ ·å¼ã€é¢œè‰²ä¸»é¢˜ä¸èŠ‚èƒ½ä¼˜åŒ–ã€‚" />
  <style>
    :root{
      --bg-top:#060a1b;
      --bg-mid:#020513;
      --bg-bottom:#000208;
      --ui-bg:rgba(15,18,30,.75);
      --ui-border:rgba(255,255,255,.12);
      --ui-text:#e8ecff;
      --accent:#8fd5ff;
      --accent-2:#ffb86c;
      --safe: env(safe-area-inset-bottom, 0px);
    }

    html,body{
      height:100%;
      margin:0;
      background: radial-gradient(1200px 700px at 50% -200px, #0b1440 0%, var(--bg-top) 40%, var(--bg-mid) 70%, var(--bg-bottom) 100%);
      color:var(--ui-text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Noto Sans CJK SC", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      overflow:hidden;
      touch-action: none; /* è®©æ‹–åŠ¨æ›´é¡ºæ»‘ */
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }

    /* æ˜Ÿæ˜Ÿå±‚ï¼ˆå¾®å¼±é—ªçƒï¼‰ */
    .stars, .stars2, .stars3 {
      position: fixed;
      inset: 0;
      pointer-events:none;
      background-repeat: repeat;
      background-position: 0 0;
      animation: drift linear infinite;
      mix-blend-mode: screen;
      opacity:.7;
    }
    .stars  { background-image: radial-gradient(2px 2px at 20px 30px, rgba(255,255,255,.9) 40%, rgba(255,255,255,0) 41%),
                                 radial-gradient(1px 1px at 80px 120px, rgba(255,255,255,.6) 50%, rgba(255,255,255,0) 51%),
                                 radial-gradient(1.5px 1.5px at 160px 200px, rgba(255,255,255,.8) 50%, rgba(255,255,255,0) 51%);
               background-size: 200px 200px; animation-duration: 120s; }
    .stars2 { background-image: radial-gradient(1.2px 1.2px at 50px 90px, rgba(255,255,200,.9) 50%, rgba(255,255,255,0) 51%),
                                 radial-gradient(1px 1px at 190px 40px, rgba(150,200,255,.8) 50%, rgba(255,255,255,0) 51%),
                                 radial-gradient(1.3px 1.3px at 120px 170px, rgba(255,255,255,.7) 50%, rgba(255,255,255,0) 51%);
               background-size: 240px 240px; animation-duration: 180s; opacity:.5;}
    .stars3 { background-image: radial-gradient(0.8px 0.8px at 90px 30px, rgba(255,255,255,.8) 50%, rgba(255,255,255,0) 51%),
                                 radial-gradient(0.8px 0.8px at 20px 150px, rgba(255,200,255,.8) 50%, rgba(255,255,255,0) 51%),
                                 radial-gradient(0.8px 0.8px at 170px 110px, rgba(200,255,255,.8) 50%, rgba(255,255,255,0) 51%);
               background-size: 300px 300px; animation-duration: 260s; opacity:.35;}
    @keyframes drift {
      from { background-position: 0 0; }
      to   { background-position: -1000px -500px; }
    }

    /* ç”»å¸ƒå±‚ */
    #scene {
      position: fixed;
      inset: 0;
      display:block;
    }

    /* é¡¶éƒ¨ä¿¡æ¯å’ŒæŒ‰é’® */
    .topbar{
      position: fixed;
      top: 10px;
      left: 12px;
      right: 12px;
      display:flex;
      gap:10px;
      align-items:center;
      z-index:10;
      pointer-events:none;
    }
    .brand{
      pointer-events:auto;
      background: linear-gradient(90deg, rgba(255,255,255,.95), rgba(255,255,255,.75));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      font-weight: 800;
      letter-spacing: .06em;
      text-shadow: 0 0 12px rgba(140,200,255,.25);
      font-size: clamp(16px, 3vw, 24px);
    }
    .spacer{flex:1;}
    .btn{
      pointer-events:auto;
      appearance:none;
      border:none;
      padding:10px 12px;
      border-radius: 10px;
      background: var(--ui-bg);
      color:var(--ui-text);
      border:1px solid var(--ui-border);
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:600;
      cursor:pointer;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      font-size: 14px;
    }
    .btn:active { transform: scale(.98); }
    .btn.toggled{ border-color: var(--accent); box-shadow: 0 0 0 2px rgba(143,213,255,.2) inset; }

    /* æ§åˆ¶é¢æ¿ï¼ˆé»˜è®¤æŠ˜å ï¼‰ */
    .panel{
      position: fixed;
      right: 12px;
      bottom: calc(12px + var(--safe));
      max-width: min(92vw, 360px);
      background: var(--ui-bg);
      color: var(--ui-text);
      border:1px solid var(--ui-border);
      border-radius: 14px;
      box-shadow: 0 8px 30px rgba(0,0,0,.35);
      overflow:hidden;
      transform-origin: bottom right;
      z-index: 12;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .panel-header{
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding:10px 12px;
      border-bottom:1px solid var(--ui-border);
      font-weight:700;
      letter-spacing:.04em;
    }
    .panel-body{
      padding: 10px 12px 12px;
      display:grid;
      gap:10px;
    }
    .row{ display:grid; gap:8px; }
    .row.inline{ grid-template-columns: 1fr auto; align-items:center; }
    label{ font-size:12px; opacity:.9; }
    select, input[type="range"], input[type="checkbox"]{
      width:100%;
      accent-color: var(--accent);
    }
    .hint{ font-size:12px; opacity:.75; }

    /* åº•éƒ¨æç¤ºä¸ç¥ç¦è¯­ */
    .footer-hint{
      position: fixed;
      left: 12px;
      bottom: calc(12px + var(--safe));
      z-index: 10;
      font-size: 12px;
      color: rgba(220,230,255,.85);
      background: rgba(0,0,0,.25);
      padding:8px 10px;
      border-radius: 10px;
      border:1px solid var(--ui-border);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      pointer-events:none;
    }
    .toast{
      position: fixed;
      top: 62px;
      left:50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,.5);
      color:#fff;
      border:1px solid var(--ui-border);
      padding:8px 12px;
      border-radius: 10px;
      font-size: 13px;
      z-index: 20;
      opacity:0;
      pointer-events:none;
      transition: opacity .25s ease, transform .25s ease;
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(0); }

    /* èŠ‚æ—¥ç¥ç¦è¯­æµ®ç° */
    .greet {
      position: fixed;
      left:50%;
      top: 28%;
      transform: translateX(-50%);
      color: #fff7d6;
      font-weight: 900;
      letter-spacing: .12em;
      text-align:center;
      font-size: clamp(20px, 6vw, 42px);
      text-shadow: 0 0 12px rgba(255,230,160,.55), 0 0 30px rgba(255,160,60,.25);
      opacity:0;
      pointer-events:none;
      z-index: 9;
      filter: drop-shadow(0 6px 16px rgba(0,0,0,.35));
      white-space: pre-line;
    }
    .greet.show{
      animation: greetPop 3.5s ease forwards;
    }
    @keyframes greetPop {
      0% { opacity:0; transform: translateX(-50%) translateY(10px) scale(.98); }
      12%{ opacity:1; transform: translateX(-50%) translateY(0) scale(1); }
      80%{ opacity:1; }
      100%{ opacity:0; transform: translateX(-50%) translateY(-10px) scale(1.02);}
    }

    /* çƒŸèŠ±æ–‡å­—æ•ˆæœ */
    .firework-text {
      position: absolute;
      color: #fff;
      font-weight: bold;
      text-align: center;
      text-shadow: 0 0 8px currentColor, 0 0 16px currentColor;
      pointer-events: none;
      z-index: 8;
      opacity: 0;
      transform: scale(0.1);
      transition: opacity 0.5s ease, transform 0.5s ease;
      white-space: nowrap;
    }

    /* å“åº”å¼ */
    @media (max-width: 480px) {
      .footer-hint { font-size:11px; }
      .btn { padding:9px 10px; font-size:13px; }
    }
  </style>
</head>
<body>
  <!-- æ˜Ÿæ˜Ÿå±‚ -->
  <div class="stars"></div>
  <div class="stars2"></div>
  <div class="stars3"></div>

  <!-- ç”»å¸ƒ -->
  <canvas id="scene" aria-label="çƒŸèŠ±è¡¨æ¼”ç”»å¸ƒ"></canvas>

  <!-- é¡¶éƒ¨æ  -->
  <div class="topbar" role="toolbar" aria-label="æ§åˆ¶æ ">
    <div class="brand"></div>
    <div class="spacer"></div>
    <button id="btn-audio" class="btn" aria-pressed="false" title="å¼€å¯/å…³é—­çƒŸèŠ±éŸ³æ•ˆ">ğŸ”Š éŸ³æ•ˆ</button>
    <button id="btn-auto" class="btn toggled" aria-pressed="true" title="è‡ªåŠ¨çƒŸèŠ±ç§€æ¨¡å¼">âœ¨ è‡ªåŠ¨</button>
    <button id="btn-panel" class="btn" aria-expanded="false" title="æ‰“å¼€æ§åˆ¶é¢æ¿">ğŸ›ï¸ æ§åˆ¶</button>
  </div>

  <!-- æ§åˆ¶é¢æ¿ï¼ˆé»˜è®¤éšè—ï¼‰ -->
  <div id="panel" class="panel" hidden>
    <div class="panel-header">
      <span>çƒŸèŠ±è‡ªå®šä¹‰</span>
      <button id="btn-close-panel" class="btn" title="æ”¶èµ·">æ”¶èµ·</button>
    </div>
    <div class="panel-body">
      <div class="row">
        <label for="type">çƒŸèŠ±ç±»å‹</label>
        <select id="type">
          <option value="classic">ç»å…¸çƒå½¢</option>
          <option value="chrys">èŠèŠ±</option>
          <option value="willow">æŸ³æ¡</option>
          <option value="spiral">èºæ—‹</option>
          <option value="heart">å¿ƒå½¢</option>
          <option value="smile">ç¬‘è„¸</option>
        </select>
      </div>
      <div class="row">
        <label for="color">é¢œè‰²ä¸»é¢˜</label>
        <select id="color">
          <option value="random">éšæœº</option>
          <option value="mono">å•è‰²</option>
          <option value="rainbow">å½©è™¹</option>
          <option value="festival">èŠ‚æ—¥ä¸»é¢˜</option>
        </select>
      </div>
      <div class="row">
        <label for="speed">å‘å°„é€Ÿåº¦</label>
        <input id="speed" type="range" min="0.6" max="1.6" step="0.02" value="1" />
      </div>
      <div class="row">
        <label for="density">å‘å°„å¯†åº¦</label>
        <input id="density" type="range" min="0.4" max="2.0" step="0.02" value="1" />
      </div>
      <div class="row inline">
        <label for="eco">èŠ‚èƒ½æ¨¡å¼</label>
        <input id="eco" type="checkbox" />
      </div>
      <div class="row inline">
        <label for="sound">éŸ³æ•ˆå¼€å…³</label>
        <input id="sound" type="checkbox" />
      </div>
      <div class="hint">æç¤ºï¼šç§»åŠ¨ç«¯é•¿æŒ‰æˆ–æ‹–åŠ¨å±å¹•å¯è¿ç»­ç‡ƒæ”¾ï¼Œç‚¹å‡»ä¸Šæ–¹"è‡ªåŠ¨"åˆ‡æ¢è‡ªåŠ¨è¡¨æ¼”ã€‚</div>
    </div>
  </div>

  <!-- åº•éƒ¨æç¤º -->
  <div class="footer-hint">
    ç‚¹å‡»/é•¿æŒ‰å±å¹•å³å¯ç‡ƒæ”¾çƒŸèŠ± Â· æ‹–åŠ¨å½¢æˆçƒŸèŠ±é›¨
  </div>

  <!-- èŠ‚æ—¥ç¥ç¦è¯­ -->
  <div id="greet" class="greet" aria-hidden="true"></div>

  <!-- è½»æç¤º -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    ;(() => {
      const canvas = document.getElementById('scene');
      const ctx = canvas.getContext('2d', { alpha: true, desynchronized: true });
      let DPR = Math.min(2, window.devicePixelRatio || 1);

      // UI elements
      const btnAudio = document.getElementById('btn-audio');
      const btnAuto = document.getElementById('btn-auto');
      const btnPanel = document.getElementById('btn-panel');
      const panel = document.getElementById('panel');
      const btnClosePanel = document.getElementById('btn-close-panel');
      const selectType = document.getElementById('type');
      const selectColor = document.getElementById('color');
      const rangeSpeed = document.getElementById('speed');
      const rangeDensity = document.getElementById('density');
      const chkEco = document.getElementById('eco');
      const chkSound = document.getElementById('sound');
      const greetEl = document.getElementById('greet');
      const toastEl = document.getElementById('toast');

      // State
      const state = {
        autoShow: true,
        allowSound: false,
        ecoMode: false,
        colorTheme: 'random',
        fwType: 'classic',
        speedMul: 1,
        densityMul: 1,
        holiday: detectHoliday(),
        lowPowerHinted: false,
      };

      // çƒŸèŠ±æ–‡å­—ç³»ç»Ÿ
      const fireworkTexts = [];
      
      // çƒŸèŠ±æ–‡å­—ç±»
      class FireworkText {
        constructor(x, y, text, color) {
          this.x = x;
          this.y = y;
          this.text = text;
          this.color = color;
          this.age = 0;
          this.life = 3.0; // æ–‡å­—æ˜¾ç¤º3ç§’
          this.element = null;
          this.createElement();
        }
        
        createElement() {
          this.element = document.createElement('div');
          this.element.className = 'firework-text';
          this.element.textContent = this.text;
          this.element.style.color = this.color;
          this.element.style.left = this.x + 'px';
          this.element.style.top = this.y + 'px';
          document.body.appendChild(this.element);
          
          // è§¦å‘åŠ¨ç”»
          setTimeout(() => {
            this.element.style.opacity = '1';
            this.element.style.transform = 'scale(1)';
          }, 10);
        }
        
        step(dt) {
          this.age += dt;
          const lifeRatio = 1 - this.age / this.life;
          
          // å‰åŠæ®µä¿æŒæ˜¾ç¤ºï¼ŒååŠæ®µé€æ¸æ¶ˆå¤±
          if (lifeRatio < 0.5) {
            this.element.style.opacity = lifeRatio * 2;
          }
          
          return lifeRatio > 0;
        }
        
        remove() {
          if (this.element && this.element.parentNode) {
            this.element.parentNode.removeChild(this.element);
          }
        }
      }

      // éšæœºç¥ç¦è¯­
      const blessings = [
        'æ–°å¹´å¿«ä¹', 'æ­å–œå‘è´¢', 'ä¸‡äº‹å¦‚æ„', 'å¿ƒæƒ³äº‹æˆ', 
        'é˜–å®¶å¹¸ç¦', 'å¹³å®‰å–œä¹', 'å¥½è¿è¿è¿', 'å‰ç¨‹ä¼¼é”¦',
        'ç¦æ˜Ÿé«˜ç…§', 'ç¬‘å£å¸¸å¼€', 'å¹¸ç¦å®‰åº·', 'å¤§å‰å¤§åˆ©'
      ];

      // éšæœºé€‰æ‹©ç¥ç¦è¯­
      function randomBlessing() {
        return blessings[Math.floor(Math.random() * blessings.length)];
      }

      // Resize canvas
      function resize() {
        const { innerWidth:w, innerHeight:h } = window;
        DPR = Math.min(2, window.devicePixelRatio || 1);
        canvas.width = Math.floor(w * DPR);
        canvas.height = Math.floor(h * DPR);
        canvas.style.width = w + 'px';
        canvas.style.height = h + 'px';
        ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
      }
      window.addEventListener('resize', resize, { passive:true });
      resize();

      // Audio (WebAudio requires user interaction to start)
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const audio = {
        ctx: null,
        gain: null,
        enabled: false,
      };
      function initAudio() {
        if (audio.ctx) return;
        audio.ctx = new AudioCtx();
        audio.gain = audio.ctx.createGain();
        audio.gain.gain.value = 0.8;
        audio.gain.connect(audio.ctx.destination);
      }
      function clickEnableAudio() {
        try {
          initAudio();
          audio.ctx.resume();
          audio.enabled = true;
          state.allowSound = true;
          btnAudio.classList.add('toggled');
          chkSound.checked = true;
          showToast('éŸ³æ•ˆå·²å¼€å¯');
        } catch(e){}
      }
      function playLaunch(x, y) {
        if (!audio.enabled || !state.allowSound) return;
        const t = audio.ctx.currentTime;
        const osc = audio.ctx.createOscillator();
        const g = audio.ctx.createGain();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(120, t);
        osc.frequency.exponentialRampToValueAtTime(40, t + 0.25);
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(0.15, t + 0.05);
        g.gain.exponentialRampToValueAtTime(0.0001, t + 0.3);
        osc.connect(g).connect(audio.gain);
        osc.start(t);
        osc.stop(t + 0.32);
      }
      function playBurst() {
        if (!audio.enabled || !state.allowSound) return;
        const t = audio.ctx.currentTime;
        const bufferSize = 2 * audio.ctx.sampleRate;
        const noiseBuffer = audio.ctx.createBuffer(1, bufferSize, audio.ctx.sampleRate);
        const out = noiseBuffer.getChannelData(0);
        for (let i=0;i<bufferSize;i++){
          out[i] = (Math.random()*2-1) * Math.pow(1 - i/bufferSize, 2);
        }
        const noise = audio.ctx.createBufferSource();
        noise.buffer = noiseBuffer;
        const bandpass = audio.ctx.createBiquadFilter();
        bandpass.type = 'bandpass';
        bandpass.frequency.value = 1600;
        const g = audio.ctx.createGain();
        g.gain.setValueAtTime(0.18, t);
        g.gain.exponentialRampToValueAtTime(0.0001, t + 1.2);
        noise.connect(bandpass).connect(g).connect(audio.gain);
        noise.start(t);
        noise.stop(t + 1.25);
      }

      // Utility
      const rand = (a,b)=>a + Math.random()*(b-a);
      const randi = (a,b)=>Math.floor(rand(a,b+1));
      const clamp = (v,a,b)=>Math.max(a, Math.min(b, v));

      function showToast(text, ms=1800){
        toastEl.textContent = text;
        toastEl.classList.add('show');
        setTimeout(()=>toastEl.classList.remove('show'), ms);
      }

      // Colors
      const palettes = {
        rainbow: ['#ff4d4d','#ffa64d','#ffe94d','#6dff4d','#4dfff6','#4d7dff','#c34dff'],
        classic: ['#ffd166','#f4978e','#c1fba4','#bde0fe','#ffafcc','#f7b801','#ff686b'],
        goldRed: ['#ff2b2b','#ff8c00','#ffd54d','#ffec99','#ff5353','#ffcc66'],
      };
      function pickColor(theme){
        if (theme === 'mono'){
          if (!pickColor.mono) pickColor.mono = `hsl(${randi(0,359)}, 90%, 60%)`;
          return pickColor.mono;
        }
        if (theme === 'rainbow'){
          return palettes.rainbow[randi(0, palettes.rainbow.length-1)];
        }
        if (theme === 'festival'){
          return palettes.goldRed[randi(0, palettes.goldRed.length-1)];
        }
        // random
        return `hsl(${randi(0,359)}, 92%, ${randi(55,65)}%)`;
      }

      // Holiday detection and greeting
      function detectHoliday(){
        const now = new Date();
        const m = now.getMonth()+1;
        const d = now.getDate();
        // ç®€æ˜“èŠ‚æ—¥åˆ¤æ–­ï¼ˆå¯æŒ‰éœ€æ‰©å±•ï¼‰
        if ((m===1 && d===1)) return { key: 'newyear', greet: 'å…ƒæ—¦å¿«ä¹\næ–°å¹´é¸¿è¿åˆ°ï¼', theme: 'festival' };
        if (isSpringFestival(now)) return { key: 'spring', greet: 'æ–°æ˜¥å¿«ä¹\nä¸‡äº‹å¦‚æ„ï¼', theme: 'festival' };
        if (m===10 && d===1) return { key: 'nation', greet: 'å›½åº†å¿«ä¹\nç¹è£æ˜Œç››ï¼', theme: 'festival' };
        return null;
      }
      // ç²—ç•¥å†œå†æ˜¥èŠ‚ä¼°ç®—ï¼ˆè¿‘å‡ å¹´èŒƒå›´ï¼‰ï¼šä½¿ç”¨è¿‘å¹´å›ºå®šè¡¨
      function isSpringFestival(date){
        const y = date.getFullYear();
        const springs = {
          2024: '2024-02-10', 2025:'2025-01-29', 2026:'2026-02-17', 2027:'2027-02-06', 2028:'2028-01-26',
          2029:'2029-02-13', 2030:'2030-02-03'
        };
        const s = springs[y];
        if(!s) return false;
        const sDate = new Date(s+'T00:00:00');
        return date.getFullYear()===sDate.getFullYear() && date.getMonth()===sDate.getMonth() && date.getDate()===sDate.getDate();
      }

      function showGreetingIfHoliday(){
        if (!state.holiday) return;
        greetEl.textContent = state.holiday.greet;
        greetEl.setAttribute('aria-hidden','false');
        greetEl.classList.add('show');
        setTimeout(()=>greetEl.classList.remove('show'), 3600);
      }
      showGreetingIfHoliday();

      // Firework system
      const W = ()=>canvas.width / DPR;
      const H = ()=>canvas.height / DPR;

      const rockets = [];
      const particles = [];
      let lastTime = performance.now();

      // Performance monitor (simple)
      let fps = 60, lowFPS = false;
      const fpsQueue = [];
      function updateFPS(dt){
        const current = 1000/dt;
        fpsQueue.push(current);
        if (fpsQueue.length > 30) fpsQueue.shift();
        fps = fpsQueue.reduce((a,b)=>a+b,0)/fpsQueue.length;
        lowFPS = fps < 28;
        if (lowFPS && !state.lowPowerHinted){
          state.lowPowerHinted = true;
          chkEco.checked = true;
          state.ecoMode = true;
          showToast('å·²è‡ªåŠ¨å¼€å¯èŠ‚èƒ½æ¨¡å¼ï¼Œä¿è¯æµç•…æ€§');
        }
      }

      class Rocket {
        constructor(x, y, targetX, targetY, color, type){
          this.x = x; this.y = y;
          this.vx = (targetX - x) * rand(0.012, 0.018) * state.speedMul;
          const vy0 = (targetY - y) * rand(0.012, 0.018) * state.speedMul;
          this.vy = vy0 - rand(3.0, 4.2) * 0.2 * state.speedMul;
          this.color = color;
          this.type = type;
          this.life = rand(0.7, 1.1);
          this.elapsed = 0;
          this.sparkT = 0;
        }
        step(dt){
          this.elapsed += dt;
          this.x += this.vx * (dt*60);
          this.y += this.vy * (dt*60);
          this.vy += 0.045 * (dt*60); // gravity
          this.sparkT += dt;
          // trail
          if (!state.ecoMode && this.sparkT > 0.016){
            this.sparkT = 0;
            spawnParticle(this.x, this.y, this.color, 0.6, 0.6, 0.2, 'trail');
          }
          // explode condition
          if (this.elapsed >= this.life || this.vy >= 0){
            explode(this.x, this.y, this.color, this.type);
            return false;
          }
          return true;
        }
        render(){}
      }

      function spawnParticle(x, y, color, size=1, speed=1, life=1, mode='burst', meta=null){
        particles.push(new Particle(x,y,color,size,speed,life,mode,meta));
      }

      class Particle {
        constructor(x, y, color, size, speed, life, mode, meta){
          this.x=x; this.y=y;
          this.color = color;
          this.baseSize = size;
          this.size = size * rand(0.7,1.3);
          this.life = life * rand(0.85,1.15);
          this.age = 0;
          this.mode = mode;
          this.meta = meta;

          if (mode==='trail'){
            this.vx = rand(-0.2,0.2);
            this.vy = rand(0.1,0.4);
            this.alpha = 0.8;
          } else {
            const a = Math.random()*Math.PI*2;
            const sp = speed * rand(1.0, 1.8) * (state.ecoMode ? 0.85 : 1);
            this.vx = Math.cos(a)*sp;
            this.vy = Math.sin(a)*sp;
            this.alpha = 1.0;
          }
          this.gravity = 0.018;
          this.drag = 0.992;
          this.twinkle = Math.random()<0.25;
        }
        step(dt){
          this.age += dt;
          if (this.mode==='trail'){
            this.alpha *= 0.92;
            this.size *= 0.98;
            this.y += this.vy * (dt*60);
            return this.alpha > 0.05;
          }
          // burst particles
          this.vx *= this.drag;
          this.vy *= this.drag;
          this.vy += this.gravity * (dt*60)/60;
          this.x += this.vx * (dt*60);
          this.y += this.vy * (dt*60);
          const lifeRatio = 1 - this.age / this.life;
          this.alpha = Math.max(0, lifeRatio);
          if (this.twinkle && Math.random()<0.1) this.alpha *= rand(0.2,1);
          return lifeRatio > 0;
        }
        render(){
          if (this.alpha <= 0) return;
          ctx.globalCompositeOperation = 'lighter';
          ctx.globalAlpha = this.alpha;
          const s = this.size;
          ctx.fillStyle = this.color;
          ctx.beginPath();
          ctx.arc(this.x, this.y, s, 0, Math.PI*2);
          ctx.fill();
          // glow
          if (!state.ecoMode){
            const g = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, s*5);
            g.addColorStop(0, this.color);
            g.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.globalAlpha = this.alpha*0.25;
            ctx.fillStyle = g;
            ctx.beginPath();
            ctx.arc(this.x, this.y, s*5, 0, Math.PI*2);
            ctx.fill();
          }
          ctx.globalAlpha = 1;
          ctx.globalCompositeOperation = 'source-over';
        }
      }

      function explode(x, y, baseColor, type){
        const colorTheme = state.colorTheme === 'festival' || state.holiday ? 'festival' : state.colorTheme;
        const pick = ()=> pickColor(colorTheme==='random' ? 'random' : colorTheme==='mono' ? 'mono' : colorTheme==='festival' ? 'festival' : 'rainbow');

        const densityBase = state.ecoMode ? 80 : 150;
        const countMul = state.densityMul * (state.ecoMode ? 0.7 : 1);
        let count = Math.floor(densityBase * countMul);

        let points = [];
        if (type === 'heart'){
          // parametric heart
          count = Math.floor(count*0.8);
          for (let i=0;i<count;i++){
            const t = Math.PI*2*i/count;
            const xx = 16*Math.pow(Math.sin(t),3);
            const yy = 13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t);
            points.push({x: xx/16, y: -yy/16});
          }
        } else if (type === 'smile'){
          // circle + smile arc + eyes
          const n = Math.floor(count*0.7);
          for (let i=0;i<n;i++){
            const a = i/n*Math.PI*2;
            points.push({x: Math.cos(a), y: Math.sin(a)});
          }
          // smile
          for (let i=0;i<60;i++){
            const a = Math.PI*0.25 + (i/60)*Math.PI*0.5;
            points.push({x: 0.6*Math.cos(a), y: 0.6*Math.sin(a)+0.1});
          }
          // eyes
          for (let i=0;i<24;i++){
            const a = i/24*Math.PI*2;
            points.push({x: -0.35 + 0.07*Math.cos(a), y: -0.2 + 0.1*Math.sin(a)});
            points.push({x:  0.35 + 0.07*Math.cos(a), y: -0.2 + 0.1*Math.sin(a)});
          }
        } else if (type === 'spiral'){
          const turns = 3;
          for (let i=0;i<count;i++){
            const t = i / count * Math.PI * 2 * turns;
            const r = i / count;
            points.push({x: r * Math.cos(t), y: r * Math.sin(t)});
          }
        } else if (type === 'willow'){
          // favor downward
          for (let i=0;i<count;i++){
            const a = Math.random()*Math.PI*2;
            const r = Math.pow(Math.random(),0.35);
            const bias = Math.cos(a);
            const yy = Math.sin(a);
            points.push({x: r*bias, y: Math.abs(yy)*r}); // more downward
          }
        } else if (type === 'chrys'){
          for (let i=0;i<count;i++){
            const a = i / count * Math.PI*2;
            const r = 1;
            points.push({x: r*Math.cos(a), y: r*Math.sin(a)});
          }
        } else {
          // classic random sphere
          for (let i=0;i<count;i++){
            const a = Math.random()*Math.PI*2;
            const r = Math.pow(Math.random(), 0.35);
            points.push({x: r*Math.cos(a), y: r*Math.sin(a)});
          }
        }

        const speed = rand(4.2, 6.0) * (state.ecoMode ? 0.8 : 1) * state.speedMul;
        const size = rand(1.2, 1.9) * (state.ecoMode ? 0.8 : 1);
        const life = rand(0.9, 1.35) * (state.ecoMode ? 0.85 : 1);

        // Create particles
        for (let i=0;i<points.length;i++){
          const p = points[i];
          const color = (state.colorTheme==='random' || state.colorTheme==='rainbow' || state.colorTheme==='festival') ? pick() : baseColor;
          const angleSpeed = Math.hypot(p.x, p.y);
          const sp = speed * (0.6 + angleSpeed*0.8);
          const part = new Particle(x, y, color, size, sp, life, 'burst');
          // direct velocity from pattern
          part.vx = p.x * sp;
          part.vy = p.y * sp;
          // add slight variance
          part.vx += rand(-0.3,0.3);
          part.vy += rand(-0.3,0.3);
          particles.push(part);
        }

        // Core flash
        if (!state.ecoMode){
          for (let i=0;i<20;i++){
            spawnParticle(x, y, baseColor, 1.2, rand(1.5,2.2), 0.5, 'burst');
          }
        }

        // sound
        playBurst();

        // æ·»åŠ çƒŸèŠ±æ–‡å­—æ•ˆæœ
        if (Math.random() < 0.3) { // 30%æ¦‚ç‡æ˜¾ç¤ºæ–‡å­—
          const text = randomBlessing();
          const textColor = pick();
          fireworkTexts.push(new FireworkText(x, y, text, textColor));
        }

        // Festival extras: occasional "ç¦" æˆ– ç®€æ˜“å›½æ——æ˜Ÿ
        if ((state.holiday?.key === 'spring' || state.holiday?.key === 'newyear') && Math.random()<0.2){
          drawGlyphBurst(x, y, 'ç¦', '#ffd54d');
        } else if (state.holiday?.key === 'nation' && Math.random()<0.25){
          drawFlagStars(x, y);
        }
      }

      function drawGlyphBurst(cx, cy, text, col){
        // draw text to offscreen and sample points
        const off = document.createElement('canvas');
        const s = 200;
        off.width = s; off.height = s;
        const octx = off.getContext('2d');
        octx.fillStyle = '#000';
        octx.fillRect(0,0,s,s);
        octx.font = 'bold 160px "Microsoft YaHei", "Noto Sans CJK SC", sans-serif';
        octx.textAlign='center';
        octx.textBaseline='middle';
        octx.fillStyle = '#fff';
        octx.fillText(text, s/2, s/2 + 10);
        const img = octx.getImageData(0,0,s,s).data;
        const step = state.ecoMode ? 6 : 4;
        for (let y=0;y<s;y+=step){
          for (let x=0;x<s;x+=step){
            const idx = (y*s + x)*4 + 3; // alpha
            if (img[idx] > 10){
              const nx = (x/s - 0.5) * 2;
              const ny = (y/s - 0.5) * 2;
              const p = new Particle(cx + nx*28, cy + ny*28, col, 1.4, rand(0.8,1.2), 1.1, 'burst');
              p.vx *= 0.2; p.vy *= 0.2;
              particles.push(p);
            }
          }
        }
      }

      function drawFlagStars(cx, cy){
        // five stars arrangement (simplified)
        const stars = [
          {x:0, y:0, r:28},   // big
          {x:60, y:-30, r:10},
          {x:80, y:-10, r:10},
          {x:80, y:20, r:10},
          {x:60, y:40, r:10},
        ];
        for (const s of stars){
          const n = state.ecoMode ? 40 : 80;
          for (let i=0;i<n;i++){
            const a = i/n * Math.PI*2;
            const px = cx + s.x + Math.cos(a)*s.r;
            const py = cy + s.y + Math.sin(a)*s.r;
            const p = new Particle(px, py, '#ffd54d', 1.3, rand(0.8,1.2), 1.0, 'burst');
            p.vx *= 0.4; p.vy *= 0.4;
            particles.push(p);
          }
        }
      }

      function launch(x, y, opt = {}){
        const baseX = x ?? rand(40, W()-40);
        const baseY = H() + 10;
        const targetX = x ?? rand(60, W()-60);
        const targetY = y ?? rand(H()*0.18, H()*0.55);
        const type = opt.type || randomType();
        const color = pickColor(state.colorTheme === 'festival' || state.holiday ? 'festival' : state.colorTheme);
        rockets.push(new Rocket(baseX, baseY, targetX, targetY, color, type));
        playLaunch(baseX, baseY);
      }

      function randomType(){
        const types = ['classic','chrys','willow','spiral','heart','smile'];
        return types[randi(0, types.length-1)];
      }

      // Auto show choreograph
      let autoTimer = 0;
      function autoChoreo(dt){
        autoTimer -= dt;
        if (autoTimer <= 0){
          const lanes = randi(2, 4);
          const pad = 30;
          for (let i=0;i<lanes;i++){
            const x = pad + (W()-pad*2) * (i + Math.random()*0.5) / lanes;
            const y = rand(H()*0.18, H()*0.5);
            const t = state.fwType === 'classic' ? randomType() : state.fwType;
            launch(x, y, { type: t });
          }
          const base = 1.3, variance = 0.6;
          autoTimer = (base + Math.random()*variance) / (state.densityMul * state.speedMul);
        }
      }

      // Input handling: click, long press, drag for continuous fire
      let isPressing = false;
      let pressInterval = 0;

      function pointerPos(e){
        const rect = canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
        return { x, y };
      }

      function onDown(e){
        isPressing = true;
        const {x,y} = pointerPos(e);
        manualFire(x,y);
        // start audio on first interaction if toggled
        if (btnAudio.classList.contains('toggled') || chkSound.checked) clickEnableAudio();
      }
      function onMove(e){
        if (!isPressing) return;
        const {x,y} = pointerPos(e);
        manualFire(x,y, true);
      }
      function onUp(){
        isPressing = false;
        pressInterval = 0;
      }
      function manualFire(x, y, continuous=false){
        pressInterval -= dtLast;
        if (!continuous || pressInterval <= 0){
          const t = Math.random()<0.5 ? state.fwType : randomType();
          launch(x, y, { type: t });
          pressInterval = clamp(0.08 / state.densityMul, 0.03, 0.15);
        }
      }

      canvas.addEventListener('mousedown', onDown);
      window.addEventListener('mousemove', onMove);
      window.addEventListener('mouseup', onUp);
      canvas.addEventListener('touchstart', (e)=>{ e.preventDefault(); onDown(e); }, { passive:false });
      canvas.addEventListener('touchmove', (e)=>{ e.preventDefault(); onMove(e); }, { passive:false });
      canvas.addEventListener('touchend', (e)=>{ e.preventDefault(); onUp(e); }, { passive:false });

      // UI interactions
      btnAuto.addEventListener('click', ()=>{
        state.autoShow = !state.autoShow;
        btnAuto.classList.toggle('toggled', state.autoShow);
        btnAuto.setAttribute('aria-pressed', String(state.autoShow));
        showToast(state.autoShow ? 'è‡ªåŠ¨çƒŸèŠ±ç§€å·²å¼€å¯' : 'è‡ªåŠ¨çƒŸèŠ±ç§€å·²æš‚åœ');
      });
      btnPanel.addEventListener('click', ()=>{
        const open = panel.hasAttribute('hidden');
        panel.toggleAttribute('hidden', !open);
        btnPanel.classList.toggle('toggled', open);
        btnPanel.setAttribute('aria-expanded', String(open));
      });
      btnClosePanel.addEventListener('click', ()=>{ panel.hidden = true; btnPanel.classList.remove('toggled'); btnPanel.setAttribute('aria-expanded','false'); });

      btnAudio.addEventListener('click', ()=>{
        if (!audio.ctx) initAudio();
        if (!audio.ctx) return;
        if (audio.ctx.state === 'suspended') audio.ctx.resume();
        audio.enabled = !audio.enabled;
        state.allowSound = audio.enabled;
        btnAudio.classList.toggle('toggled', audio.enabled);
        btnAudio.setAttribute('aria-pressed', String(audio.enabled));
        chkSound.checked = audio.enabled;
        showToast(audio.enabled ? 'éŸ³æ•ˆå·²å¼€å¯' : 'éŸ³æ•ˆå·²å…³é—­');
      });

      selectType.addEventListener('change', ()=>{ state.fwType = selectType.value; });
      selectColor.addEventListener('change', ()=>{
        state.colorTheme = selectColor.value;
        if (state.colorTheme !== 'mono') pickColor.mono = null; // reset mono cache
        if (state.colorTheme === 'festival' && !state.holiday){
          showToast('å·²åˆ‡æ¢åˆ°èŠ‚æ—¥ä¸»é¢˜');
        }
      });
      rangeSpeed.addEventListener('input', ()=>{ state.speedMul = parseFloat(rangeSpeed.value); });
      rangeDensity.addEventListener('input', ()=>{ state.densityMul = parseFloat(rangeDensity.value); });
      chkEco.addEventListener('change', ()=>{ state.ecoMode = chkEco.checked; showToast(state.ecoMode ? 'èŠ‚èƒ½æ¨¡å¼å¼€å¯' : 'èŠ‚èƒ½æ¨¡å¼å…³é—­'); });
      chkSound.addEventListener('change', ()=>{
        if (chkSound.checked){ clickEnableAudio(); }
        else { state.allowSound = false; audio.enabled = false; btnAudio.classList.remove('toggled'); btnAudio.setAttribute('aria-pressed','false'); showToast('éŸ³æ•ˆå·²å…³é—­'); }
      });

      // Initialize defaults (apply holiday theme)
      if (state.holiday){
        state.colorTheme = 'festival';
        selectColor.value = 'festival';
      }

      // Render loop
      let dtLast = 0;
      function loop(t){
        const dt = Math.min(0.05, (t - lastTime)/1000); // cap
        dtLast = dt;
        lastTime = t;
        updateFPS(dt);

        // Clear with subtle fade for trails
        ctx.globalCompositeOperation = 'source-over';
        ctx.globalAlpha = state.ecoMode ? 0.35 : 0.25;
        ctx.fillStyle = '#000214';
        ctx.fillRect(0,0,W(),H());
        ctx.globalAlpha = 1;

        // Auto show
        if (state.autoShow){
          autoChoreo(dt);
        }

        // Update rockets
        for (let i=rockets.length-1;i>=0;i--){
          const r = rockets[i];
          if (!r.step(dt)) rockets.splice(i,1);
        }

        // Update particles
        const maxParticles = state.ecoMode ? 900 : 1800;
        for (let i=particles.length-1;i>=0;i--){
          if (!particles[i].step(dt)) particles.splice(i,1);
        }
        // Soft cap
        if (particles.length > maxParticles){
          particles.splice(0, particles.length - maxParticles);
        }

        // Update firework texts
        for (let i=fireworkTexts.length-1;i>=0;i--){
          if (!fireworkTexts[i].step(dt)) {
            fireworkTexts[i].remove();
            fireworkTexts.splice(i,1);
          }
        }

        // Render particles
        for (let i=0;i<particles.length;i++){
          particles[i].render();
        }

        requestAnimationFrame(loop);
      }
      requestAnimationFrame(loop);

      // Start with a small choreographed burst
      setTimeout(()=>{
        const n = 3;
        for (let i=0;i<n;i++){
          setTimeout(()=>{
            launch(rand(80, W()-80), rand(H()*0.2, H()*0.5), { type: randomType() });
          }, i*260);
        }
      }, 400);

      // Multi-emitters at bottom firing for "multi cannon" look in auto mode
      setInterval(()=>{
        if (!state.autoShow) return;
        const pads = randi(2,4);
        for (let i=0;i<pads;i++){
          const x = rand(40, W()-40);
          const y = rand(H()*0.25, H()*0.55);
          launch(x, y, { type: randomType() });
        }
      }, 5000);

      // Visibility handling to save CPU
      document.addEventListener('visibilitychange', ()=>{
        if (document.hidden){
          state.autoShow = false;
          btnAuto.classList.remove('toggled');
          btnAuto.setAttribute('aria-pressed','false');
        } else {
          // don't auto resume to respect user; hint once
          if (!state.lowPowerHinted){
            showToast('å·²æš‚åœåŠ¨ç”»ï¼ˆåå°ï¼‰ï¼Œç‚¹å‡»"è‡ªåŠ¨"ç»§ç»­è¡¨æ¼”');
            state.lowPowerHinted = true;
          }
        }
      });

    })();
  </script>
</body>
</html>